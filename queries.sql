# list of unique outputs per input
SELECT short, array_agg(DISTINCT output) as output
FROM result
JOIN input ON (input.id = input)
JOIN version ON (version.id = version)
WHERE NOT "isHelper" AND output != 11
GROUP BY short
HAVING COUNT(DISTINCT output) < 3
LIMIT 30;

# archive a version. First up archive limit, then update trigger + move rows, then up current limit.
# determine list of eol-versions: SELECT array_agg(id) FROM version WHERE eol < now();

BEGIN;
  ALTER TABLE result_archive DROP CONSTRAINT "isArchive";
  ALTER TABLE result_archive ADD CONSTRAINT "isArchive" CHECK (version IN (5,8,10,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,168,169,170,172,174,175,177,178,179,181,182,183,186,187,189,190,192,194,197,200,204,205,209,212,214,231,234,238,241,245,248,254,258,290,291,292));
COMMIT;

CREATE OR REPLACE FUNCTION result_insert_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF (NEW.version NOT IN(5,8,10,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,168,169,170,172,174,175,177,178,179,181,182,183,186,187,189,190,192,194,197,200,204,205,209,212,214,231,234,238,241,245,248,254,258,290,291,292)) THEN
        INSERT INTO result_current VALUES (NEW.*);
    ELSE
        INSERT INTO result_archive VALUES (NEW.*);
    END IF;
    RETURN NULL;
END;
$$
LANGUAGE plpgsql;

BEGIN;
  INSERT INTO result_archive SELECT * FROM result_current WHERE (version IN(5,8,10,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,168,169,170,172,174,175,177,178,179,181,182,183,186,187,189,190,192,194,197,200,204,205,209,212,214,231,234,238,241,245,248,254,258,290,291,292));
  DELETE FROM result_current WHERE (version IN(5,8,10,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,168,169,170,172,174,175,177,178,179,181,182,183,186,187,189,190,192,194,197,200,204,205,209,212,214,231,234,238,241,245,248,254,258,290,291,292));
COMMIT;

BEGIN;
  ALTER TABLE result_current DROP CONSTRAINT "isCurrent";
  ALTER TABLE result_current ADD CONSTRAINT "isCurrent" CHECK (version NOT IN(5,8,10,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,168,169,170,172,174,175,177,178,179,181,182,183,186,187,189,190,192,194,197,200,204,205,209,212,214,231,234,238,241,245,248,254,258,290,291,292));
COMMIT;